本文档记录了项目的订阅付费逻辑规则。

# 一、场景决策矩阵

| 当前用户状态 | 购买 7-Day | 购买 Monthly | 购买 Lifetime |
|---|---|---|---|
| **Free 用户** | ✅ 可以 | ✅ 可以 | ✅ 可以 |
| **7-Day Pass 用户** | ✅ 可以叠加 (+7天) | ✅ 可以升级 (赠送剩余天数) | ✅ 可以 (覆盖) |
| **Monthly 用户** | ❌ 不可以 (已有更高服务) | ✅ 自动续订 | ✅ 可以 (覆盖) |
| **Lifetime 用户** | ❌ 不可以 (已是永久) | ❌ 不可以 (已是永久) | ❌ 不可以 (已是永久) |

---

# 二、详细规则

## 1. 7-Day Pass 叠加购买

- **规则**: 7-Day Pass 用户可以再次购买 7-Day Pass
- **处理**: 将新购买的 7 天累加到当前 `expires_at`
  - 如果当前未过期: `新过期时间 = 当前过期时间 + 7天`
  - 如果已过期: `新过期时间 = 现在 + 7天`
- **前端显示**: 按钮文案变为 "Add 7 more days"

## 2. 7-Day 用户升级 Monthly

- **规则**: 允许升级
- **处理**: 计算剩余 7-Day 天数，记录为 `bonus_days`
  - `bonus_days = ceil((expires_at - now) / 1天)`
- **用途**: 可用于后续营销或延长首月服务

## 3. Lifetime 用户

- **规则**: 不能购买任何计划
- **前端显示**: 按钮禁用，显示 "You're a lifetime member!"

## 4. Monthly 自动续订

- **规则**: 由 Creem 支付网关自动处理
- **Webhook**: `onGrantAccess` 事件在续订时触发

---

# 三、技术实现

- **后端验证**: `app/api/webhook/creem/route.ts` - `canUpgrade()` 函数
- **前端验证**: `components/pricing-card.tsx` - `canPurchase()` 函数
- **数据库字段**: `subscriptions` 表
  - `plan`: "free" | "7day" | "monthly" | "lifetime"
  - `expires_at`: 7-Day Pass 过期时间
  - `bonus_days`: 升级时赠送的天数
